Ext.util.MD5=function(p,n,m,j){n=n||false;m=m||false;j=j||8;function g(q,u){var t=(q&65535)+(u&65535);var s=(q>>16)+(u>>16)+(t>>16);return(s<<16)|(t&65535)}function l(q,s){return(q<<s)|(q>>>(32-s))}function c(A,w,v,u,z,y){return g(l(g(g(w,A),g(u,y)),z),v)}function h(v,u,A,z,q,y,w){return c((u&A)|((~u)&z),v,u,q,y,w)}function b(v,u,A,z,q,y,w){return c((u&z)|(A&(~z)),v,u,q,y,w)}function k(v,u,A,z,q,y,w){return c(u^A^z,v,u,q,y,w)}function f(v,u,A,z,q,y,w){return c(A^(u|(~z)),v,u,q,y,w)}function e(C,w){C[w>>5]|=128<<((w)%32);C[(((w+64)>>>9)<<4)+14]=w;var B=1732584193;var A=-271733879;var z=-1732584194;var y=271733878;for(var t=0;t<C.length;t+=16){var v=B;var u=A;var s=z;var q=y;B=h(B,A,z,y,C[t+0],7,-680876936);y=h(y,B,A,z,C[t+1],12,-389564586);z=h(z,y,B,A,C[t+2],17,606105819);A=h(A,z,y,B,C[t+3],22,-1044525330);B=h(B,A,z,y,C[t+4],7,-176418897);y=h(y,B,A,z,C[t+5],12,1200080426);z=h(z,y,B,A,C[t+6],17,-1473231341);A=h(A,z,y,B,C[t+7],22,-45705983);B=h(B,A,z,y,C[t+8],7,1770035416);y=h(y,B,A,z,C[t+9],12,-1958414417);z=h(z,y,B,A,C[t+10],17,-42063);A=h(A,z,y,B,C[t+11],22,-1990404162);B=h(B,A,z,y,C[t+12],7,1804603682);y=h(y,B,A,z,C[t+13],12,-40341101);z=h(z,y,B,A,C[t+14],17,-1502002290);A=h(A,z,y,B,C[t+15],22,1236535329);B=b(B,A,z,y,C[t+1],5,-165796510);y=b(y,B,A,z,C[t+6],9,-1069501632);z=b(z,y,B,A,C[t+11],14,643717713);A=b(A,z,y,B,C[t+0],20,-373897302);B=b(B,A,z,y,C[t+5],5,-701558691);y=b(y,B,A,z,C[t+10],9,38016083);z=b(z,y,B,A,C[t+15],14,-660478335);A=b(A,z,y,B,C[t+4],20,-405537848);B=b(B,A,z,y,C[t+9],5,568446438);y=b(y,B,A,z,C[t+14],9,-1019803690);z=b(z,y,B,A,C[t+3],14,-187363961);A=b(A,z,y,B,C[t+8],20,1163531501);B=b(B,A,z,y,C[t+13],5,-1444681467);y=b(y,B,A,z,C[t+2],9,-51403784);z=b(z,y,B,A,C[t+7],14,1735328473);A=b(A,z,y,B,C[t+12],20,-1926607734);B=k(B,A,z,y,C[t+5],4,-378558);y=k(y,B,A,z,C[t+8],11,-2022574463);z=k(z,y,B,A,C[t+11],16,1839030562);A=k(A,z,y,B,C[t+14],23,-35309556);B=k(B,A,z,y,C[t+1],4,-1530992060);y=k(y,B,A,z,C[t+4],11,1272893353);z=k(z,y,B,A,C[t+7],16,-155497632);A=k(A,z,y,B,C[t+10],23,-1094730640);B=k(B,A,z,y,C[t+13],4,681279174);y=k(y,B,A,z,C[t+0],11,-358537222);z=k(z,y,B,A,C[t+3],16,-722521979);A=k(A,z,y,B,C[t+6],23,76029189);B=k(B,A,z,y,C[t+9],4,-640364487);y=k(y,B,A,z,C[t+12],11,-421815835);z=k(z,y,B,A,C[t+15],16,530742520);A=k(A,z,y,B,C[t+2],23,-995338651);B=f(B,A,z,y,C[t+0],6,-198630844);y=f(y,B,A,z,C[t+7],10,1126891415);z=f(z,y,B,A,C[t+14],15,-1416354905);A=f(A,z,y,B,C[t+5],21,-57434055);B=f(B,A,z,y,C[t+12],6,1700485571);y=f(y,B,A,z,C[t+3],10,-1894986606);z=f(z,y,B,A,C[t+10],15,-1051523);A=f(A,z,y,B,C[t+1],21,-2054922799);B=f(B,A,z,y,C[t+8],6,1873313359);y=f(y,B,A,z,C[t+15],10,-30611744);z=f(z,y,B,A,C[t+6],15,-1560198380);A=f(A,z,y,B,C[t+13],21,1309151649);B=f(B,A,z,y,C[t+4],6,-145523070);y=f(y,B,A,z,C[t+11],10,-1120210379);z=f(z,y,B,A,C[t+2],15,718787259);A=f(A,z,y,B,C[t+9],21,-343485551);B=g(B,v);A=g(A,u);z=g(z,s);y=g(y,q)}return[B,A,z,y]}function a(u){var t=[];var q=(1<<j)-1;for(var s=0;s<u.length*j;s+=j){t[s>>5]|=(u.charCodeAt(s/j)&q)<<(s%32)}return t}function d(t){var u="";var q=(1<<j)-1;for(var s=0;s<t.length*32;s+=j){u+=String.fromCharCode((t[s>>5]>>>(s%32))&q)}return u}function o(t){var s=m?"0123456789ABCDEF":"0123456789abcdef";var u="";for(var q=0;q<t.length*4;q++){u+=s.charAt((t[q>>2]>>((q%4)*8+4))&15)+s.charAt((t[q>>2]>>((q%4)*8))&15)}return u}return(n?d(e(a(p),p.length*j)):o(e(a(p),p.length*j)))};Ext.define("Ext.util.LoggerConstants",{statics:{NONE:10,ERROR:4,WARNING:3,INFO:2,DEBUG:1,STR_TO_LEVEL:{debug:1,info:2,warn:3,error:4,none:10,},}});Ext.define("Ext.util.Logger",{statics:{level:Ext.util.LoggerConstants.ERROR,setLevel:function(a){if(Ext.util.LoggerConstants.STR_TO_LEVEL[a]){Ext.util.Logger.level=Ext.util.LoggerConstants.STR_TO_LEVEL[a]}else{Ext.util.Logger.level=Ext.util.LoggerConstants.NONE}},debug:function(){if(Ext.util.Logger.level<=Ext.util.LoggerConstants.DEBUG){console.log.apply(console,arguments)}},info:function(){if(Ext.util.Logger.level<=Ext.util.LoggerConstants.INFO){console.log.apply(console,arguments)}},warn:function(){if(Ext.util.Logger.level<=Ext.util.LoggerConstants.WARNING){console.log.apply(console,arguments)}},error:function(){if(Ext.util.Logger.level<=Ext.util.LoggerConstants.ERROR){console.log.apply(console,arguments)}}}});Ext.util.UUIDGenerator={generate:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var b=Math.random()*16|0,a=d=="x"?b:(b&3|8);return a.toString(16)})},};Ext.define("Ext.io",{statics:{config:{key:null,url:"http://msg.sencha.io",},messaging:null,setup:function(a){Ext.apply(Ext.io.config,a)},init:function(){if(!Ext.io.messaging){if(Ext.io.config.logLevel){Ext.util.Logger.setLevel(Ext.io.config.logLevel)}if(!Ext.io.config.key){Ext.io.config.key=Ext.util.Cookie.getItem("connect.sid")}Ext.io.messaging=Ext.create("Ext.io.Messaging",Ext.io.config)}},getCurrentApp:function(b,a){Ext.io.init();Ext.io.App.getCurrent(b,a)},getCurrentDevice:function(b,a){Ext.io.init();Ext.io.Device.getCurrent(b,a)},getCurrentGroup:function(b,a){Ext.io.init();Ext.io.Group.getCurrent(b,a)},getCurrentUser:function(b,a){Ext.io.init();Ext.io.User.getCurrent(b,a)},getService:function(a,c,b){Ext.io.init();Ext.io.messaging.getService(a,c,b)},getQueue:function(a,c,b){Ext.io.init();Ext.io.messaging.getQueue(a,c,b)},send:function(h,d,g,c,a){Ext.io.init();if(!h){Ext.util.Logger.error("id is not valid. Should be of the form 'target/name', e.g. client/861231");a.call(c,"MISSING_ID");return}var f=h.split("/");var e=f[0];var b=f[1];switch(e){case"client":Ext.io.messaging.transport.sendToClient(b,d,g,c);break;case"service":Ext.io.messaging.transport.sendToService(b,d,g,c);break;case"queue":Ext.io.messaging.pubsub.publish(b,d,g,c);break;default:Ext.util.Logger.error("Target is not valid. Should be one of 'client', 'service' or 'queue' : "+e);g.call(c,"INVALID_TARGET",null);break}},subscribe:function(g,f,c,a){Ext.io.init();if(!g){Ext.util.Logger.error("id is not valid. Should be of the form 'target/name', e.g. client/861231");a.call(c,"MISSING_ID");return}var e=g.split("/");var d=e[0];var b=e[1];switch(d){case"service":Ext.io.messaging.transport.subscribe(b,function(j,h){if(j){a.call(c,j,h)}else{Ext.io.messaging.transport.setListener(b,function(k){f.call(c,k.service,k.msg)},this)}},this);break;case"queue":Ext.io.messaging.pubsub.subscribe(b,f,c,a);break;default:Ext.util.Logger.error("Target is not valid. Should be one of 'service' or 'queue' : "+d);a.call(c,"INVALID_TARGET");break}},unsubscribe:function(g,f,c,a){Ext.io.init();if(!g){Ext.util.Logger.error("id is not valid. Should be of the form 'target/name', e.g. client/861231");a.call(c,"MISSING_ID");return}var e=g.split("/");var d=e[0];var b=e[1];switch(d){case"service":Ext.io.messaging.transport.unsubscribe(b,f,c);break;case"queue":Ext.io.messaging.pubsub.unsubscribe(b,f,c);break;default:Ext.util.Logger.error("Target is not valid. Should be one of 'service' or 'queue' : "+d);a.call(c,"INVALID_TARGET");break}},listen:function(a,c,b){Ext.io.init();Ext.io.messaging.transport.setListener(a,function(d){c.call(b,d.from,d.msg)},this)}}});Ext.define("Ext.io.Transport",{naming:null,transport:null,oldConsoleLog:null,listeners:{},transportClasses:{polling:"Ext.io.transports.PollingTransport",socket:"Ext.io.transports.SocketIoTransport",},config:{key:"",url:"http://msg.sencha.io",clientId:"",piggybacking:true,maxEnvelopesPerReceive:10,transportName:""},constructor:function(a,c){this.initConfig(a);this.naming=c;if(!this.getClientId()){this.setClientId(this.naming.getClientId())}a.clientId=this.getClientId();var b=this;this.transportName=a.transportName||"polling";Ext.util.Logger.info("Using transport name ",this.transportName);this.transport=Ext.create(this.transportClasses[this.transportName],a);this.transport.start();this.transport.on("receive",function(d){b.receive(d)});return this},setListener:function(b,c,a){this.listeners[b]={listener:c,scope:a}},removeListener:function(a){delete this.listeners[a]},sendToService:function(c,d,a,b){this.send({service:c,msg:d},a,b)},sendToClient:function(c,d,a,b){this.send({to:c,service:"courier",msg:d},a,b)},send:function(d,b,c){var a=this;d.from=this.getClientId();Ext.util.Logger.debug("Transport.send "+JSON.stringify(d));this.transport.send(d,function(f,e){if(b){b.call(c,f,e)}})},receive:function(b){Ext.util.Logger.debug("Transport.receive "+JSON.stringify(b));if(this.listeners[b.service]){var a=this.listeners[b.service];a.listener.call(a.scope,b)}else{Ext.util.Logger.error("No listener for "+b.service)}},subscribe:function(c,a,b){Ext.util.Logger.debug("Transport.subscribe "+c);var d={key:this.getKey(),client_id:this.getClientId(),service:c};this.transport.subscribe(d,function(f,e){if(a){a.call(b,f,e)}})},unsubscribe:function(c,a,b){Ext.util.Logger.debug("Transport.unsubscribe "+c);var d={key:this.getKey(),client_id:this.getClientId(),service:c};this.transport.unsubscribe(d,function(f,e){if(a){a.call(b,f,e)}})}});Ext.define("Ext.io.Rpc",{currentCallId:0,callMap:{},transport:null,config:{},constructor:function(a,b){this.initConfig(a);this.transport=b;return this},generateCallId:function(){return ++this.currentCallId},subscribe:function(a){this.callback(a.msg["corr-id"],a)},dispatch:function(c,b){var a=this.generateCallId();c.msg["corr-id"]=a;c.from=this.transport.getClientId();this.callMap[a]=b;this.transport.send(c,function(){},this)},callback:function(a,b){a=parseInt(a);if(!this.callMap[a]){Ext.util.Logger.warn("No associated call with this envelope available: "+a)}else{this.callMap[a](b.msg.result);delete this.callMap[a]}},call:function(b,d,c,f,a){this.transport.setListener("rpc",this.subscribe,this);this.transport.setListener(d,this.subscribe,this);switch(c){case"subscriber":var e={service:d,from:this.transport.getClientId(),msg:{method:f,args:a}};this.dispatch(e,b);break;case"direct":var e={service:"rpc",from:this.transport.getClientId(),msg:{service:d,method:f,args:a}};this.dispatch(e,b);break;default:Ext.util.Logger.error(c+" is an invalid RPC style. Should be 'direct' or 'subscriber'");throw"Invalid RPC style: "+c;break}}});Ext.define("Ext.io.Proxy",{name:null,descriptor:null,rpc:null,constructor:function(a,b,c){this.name=a;this.descriptor=b;this.rpc=c;if(this.descriptor.kind!="rpc"){Ext.util.Logger.error(this.name+" is not a RPC service");throw"Error, proxy does not support non-RPC calls"}this._createMethodProxies();return this},_createMethodProxies:function(){var b=this;for(var c=0;c<this.descriptor.methods.length;c++){var a=this.descriptor.methods[c];b[a]=b._createMethodProxy(a)}},_createMethodProxy:function(b){var a=this;return function(){arguments.slice=Array.prototype.slice;var c=arguments.slice(0);var d=a.descriptor.style[0];if(a.descriptor.style.indexOf("subscriber")>0){d="subscriber"}a.rpc.call(c[0],a.name,d,b,c.slice(1))}}});Ext.define("Ext.io.Service",{name:null,descriptor:null,transport:null,constructor:function(a,b,c){this.name=a;this.descriptor=b;this.transport=c;return this},send:function(b,c,a){this.transport.sendToService(this.name,b,c,a)},receive:function(b,a){this.transport.setListener(this.name,function(c){b.call(a,c.from,c.msg)},this)},subscribe:function(d,c,a){var b=this;b.transport.subscribe(b.name,function(f,e){if(f){if(a){a.call(c,f,e)}}else{b.transport.setListener(b.name,function(g){d.call(c,g.service,g.msg)},b)}},b)},unsubscribe:function(c,b,a){Ext.io.messaging.transport.unsubscribe(this.name,function(e,d){if(e){if(a){a.call(b,e,d)}}else{c.call(b,e,d)}},this)}});Ext.define("Ext.io.Messaging",{proxyCache:{},queueCache:{},naming:null,transport:null,rpc:null,pubsub:null,config:{},constructor:function(a){this.initConfig(a);this.naming=Ext.create("Ext.io.Naming",a,this);this.transport=Ext.create("Ext.io.Transport",a,this.naming);this.rpc=Ext.create("Ext.io.Rpc",a,this.transport);this.pubsub=Ext.create("Ext.io.PubSub",a,this.transport);return this},getService:function(d,e,c){var b=this;var a=this.proxyCache[d];if(a){e.call(c,a)}else{b.naming.getServiceDescriptor(d,function(f){if(f==null){Ext.util.Logger.error("Unable to load service descriptor for "+d);e.call(c,null)}else{if(f.kind=="rpc"){a=Ext.create("Ext.io.Proxy",d,f,b.rpc)}else{a=Ext.create("Ext.io.Service",d,f,b.transport)}b.proxyCache[d]=a;e.call(c,a)}})}},getQueue:function(d,e,c){var b=this;var a=this.queueCache[d];if(a){e.call(c,a)}else{a=Ext.create("Ext.io.Queue",d,this.pubsub);this.queueCache[d]=a;e.call(c,a)}}});Ext.define("Ext.io.PubSub",{queueCallbackMap:{},transport:null,config:{},constructor:function(a,b){this.initConfig(a);this.transport=b;return this},handleIncoming:function(c){var b=c.msg.queue;if(b&&this.queueCallbackMap[b]){var a=this.queueCallbackMap[b];a.callback.call(a.scope,c.from,c.msg.data)}else{Ext.util.Logger.warn("PubSub: No callback for queueName "+b)}},publish:function(d,c,a,b){this.transport.send({service:"client-pubsub",msg:{api:"publish",queue:d,data:c}},a,b)},subscribe:function(e,b,c,d){var a=this;this.transport.setListener("client-pubsub",this.handleIncoming,this);this.transport.send({service:"client-pubsub",msg:{api:"subscribe",queue:e}},function(f){if(f){if(d){d.call(c,f)}}else{a.queueCallbackMap[e]={callback:b,scope:c};Ext.util.Logger.info("client-pubsub: "+a.transport.getClientId()+" subscribed to "+e)}},this)},unsubscribe:function(d,b,c){var a=this;delete this.queueCallbackMap[d];this.transport.send({service:"client-pubsub",msg:{api:"unsubscribe",queue:d}},function(e){Ext.util.Logger.info("client-pubsub: "+a.transport.getClientId()+" unsubscribed to "+d);if(b){b.call(c,e)}},this)}});Ext.define("Ext.io.AuthStrategies",{statics:{nc:0,getRequestCounter:function(){return ++Ext.io.AuthStrategies.nc},strategies:{digest:function(a,e,f,d){var b=e.login;var c=e.password;a.messaging.getService("authorization",function(g){g.realmAuthDigest(function(q){if(q.status=="success"){var m=q.value.nonce;var h="auth";var l=""+Ext.io.AuthStrategies.getRequestCounter();var p=Ext.util.UUIDGenerator.generate();var o=Ext.util.MD5(b+":"+a.key+":"+c);var j=a.messaging.transport.getUrl();var n=Ext.util.MD5("POST:"+j);var k=Ext.util.MD5(o+":"+m+":"+l+":"+p+":"+h+":"+n);g.realmAuthDigest(function(s){if(s.status=="success"){f.call(d,false,Ext.create("Ext.io.User",s.value._bucket,s.value._key,s.value.data,a.messaging))}else{f.call(d,true,null)}},a.key,b,m,j,h,l,p,k)}else{f.call(d,true,null)}},a.key)},this)}}}});Ext.define("Ext.io.Queue",{name:null,pubsub:null,constructor:function(a,b){this.name=a;this.pubsub=b;return this},publish:function(b,c,a){this.pubsub.publish(this.name,b,c,a)},subscribe:function(c,b,a){this.pubsub.subscribe(this.name,c,b,a)},unsubscribe:function(b,a){this.pubsub.unsubscribe(this.name,b,a)}});Ext.define("Ext.io.transports.PollingTransport",{mixins:{observable:"Ext.util.Observable"},intervalId:null,config:{key:"",url:"http://msg.sencha.io",clientId:"",piggybacking:true,maxEnvelopesPerReceive:10,pollingDuration:5000},constructor:function(a){this.initConfig(a);this.mixins.observable.constructor.call(this);return this},getReceiveInvoker:function(){var a=this;var b=function(d,c){a.responseHandler(d,c)};Ext.util.Logger.debug("PollingTransport receive...");a.ajaxRequest("/receive",{key:a.config.key,client_id:a.config.clientId,max:a.config.maxEnvelopesPerReceive},{},b)},start:function(){var a=this;this.intervalId=setInterval(function(){a.getReceiveInvoker()},this.config.pollingDuration)},stop:function(){clearInterval(this.intervalId)},responseHandler:function(e,c){var b=this;if(!e){Ext.util.Logger.debug("PollingTransport responseHandler: "+c.responseText);var f=Ext.decode(c.responseText);if(f!=null){var a=f.envelopes;var g=f.hasMore;if(g){setTimeout(function(){b.getReceiveInvoker()},0)}if(a!=null){for(var d=0;d<a.length;d++){this.fireEvent("receive",a[d])}}}}else{Ext.util.Logger.debug("PollingTransport responseHandler error: "+c.status)}},send:function(b,c){var a=this;this.ajaxRequest("/send",{key:this.config.key,max:this.config.maxEnvelopesPerReceive},b,function(e,d){c(e,d);if(a.config.piggybacking){a.responseHandler(e,d)}})},subscribe:function(a,b){this.ajaxRequest("/subscribe",a,{},b)},unsubscribe:function(a,b){this.ajaxRequest("/unsubscribe",a,{},b)},ajaxRequest:function(c,d,b,a){if(!this.config.piggybacking){d.pg=0}Ext.Ajax.request({method:"POST",url:this.config.url+c,params:d,jsonData:b,scope:this,success:function(e){if(a){a(null,e)}},failure:function(e){if(a){a("error",e)}}})}});Ext.ns("Ext.io.transports");Ext.define("Ext.io.transports.SocketIoTransport",{mixins:{observable:"Ext.util.Observable"},config:{key:"",url:"http://msg.sencha.io",clientId:""},constructor:function(a){a=a||{};console.log("config",a);Ext.apply(this,a);this.mixins.observable.constructor.call(this)},start:function(){Ext.util.Logger.debug("connecting to ",this.url);var a=this;a.socket=io.connect(a.url);a.socket.on("receive",function(b){a._receive(b)});a.socket.on("connect",function(){Ext.util.Logger.debug("start",a.clientId);a.socket.emit("start",{client_id:a.clientId})})},send:function(a,b){a.key=this.key;this._emit("send",a,b)},subscribe:function(a,b){this._emit("subscribe",a,b)},unsubscribe:function(a,b){this._emit("unsubscribe",a,b)},_emit:function(b,a,c){console.log("send socket",this.socket,a);if(this.socket){this.socket.emit(b,a,c)}},_receive:function(c){Ext.util.Logger.debug("_receive",c);if(c.envelope){this.fireEvent("receive",c.envelope)}else{if(c.envelopes&&c.envelopes.length>0){var a=c.envelopes.length;for(var b=0;b<a;b++){this.fireEvent("receive",c.envelopes[b])}}}}});Ext.define("Ext.util.Cookie",{statics:{hasItem:function(a){return(new RegExp("(?:^|;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=")).test(document.cookie)},getItem:function(a){if(!a||!this.hasItem(a)){return null}return unescape(document.cookie.replace(new RegExp("(?:^|.*;\\s*)"+escape(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1"))}}});Ext.define("Ext.io.Naming",{messaging:null,config:{},constructor:function(b,a){this.initConfig(b);this.messaging=a;return this},generateClientId:function(){return Ext.io.UUIDGenerator.generate()},getClientIdFromLocalStorage:function(){var a=null;try{if("localStorage" in window&&window.localStorage!==null){a=window.localStorage["sencha.io.client.uuid"]}}catch(b){a=null}return a},storeClientIdInLocalStorage:function(a){window.localStorage["sencha.io.client.uuid"]=a},getClientId:function(){var a=this.getClientIdFromLocalStorage();if(!a){a=this.generateClientId();this.storeClientIdInLocalStorage(a)}return a},getServiceDescriptor:function(b,c,a){if(b=="naming-rpc"){c.call(a,{kind:"rpc",style:["subscriber"],access:["clients","servers"],depends:["messaging","naming"],methods:["getServiceDescriptor","get","find","update","getSingleLink","getRelatedEntities","findRelatedEntities"]})}else{this.messaging.getService("naming-rpc",function(d){d.getServiceDescriptor(function(e){if(e.status=="success"){c.call(a,e.value)}else{c.call(a,null)}},b)},this)}}});Ext.define("Ext.io.Entity",{bucket:null,key:null,data:null,constructor:function(d,b,c,a){this.bucket=d;this.key=b;this.data=c;this.messaging=a},update:function(e,f,d){var b=this;var c=false;for(var a in e){b.data[a]=e[a]}this.messaging.getService("naming-rpc",function(g){g.update(function(h){if(h.status=="success"){f.call(d,false)}else{f.call(d,true)}},b.bucket,b.key,b.data)},this)},getSingleLink:function(g,d,a,c,f,e){var b=this;this.messaging.getService("naming-rpc",function(h){h.getSingleLink(function(j){if(j.status=="success"){var k=null;if(j.value!=null){k=Ext.create(c,j.value._bucket,j.value._key,j.value.data,b.messaging)}f.call(e,false,k)}else{f.call(e,true,null)}},b.bucket,b.key,g,d,a)},this)},getRelatedEntities:function(f,a,c,e,d){var b=this;this.messaging.getService("naming-rpc",function(g){g.getRelatedEntities(function(h){if(h.status=="success"){var k=[];for(var j=0;j<h.value.length;j++){k.push(Ext.create(c,h.value[j]._bucket,h.value[j]._key,h.value[j].data,b.messaging))}e.call(d,false,k)}else{e.call(d,true,null)}},b.bucket,b.key,f,a)},this)},findRelatedEntities:function(h,d,a,f,c,g,e){var b=this;this.messaging.getService("naming-rpc",function(j){j.findRelatedEntities(function(k){if(k.status=="success"){var m=[];for(var l=0;l<k.value.length;l++){m.push(Ext.create(c,k.value[l]._bucket,k.value[l]._key,k.value[l].data,b.messaging))}g.call(e,false,m)}else{g.call(e,true,null)}},b.bucket,b.key,h,d,a,f)},this)}});Ext.define("Ext.io.Entities",{CLASS_MAP:{Realms:"Ext.io.Group",Apps:"Ext.io.App",Users:"Ext.io.User",Instances:"Ext.io.Device"},bucket:null,constructor:function(b,a){this.bucket=b;this.messaging=a},get:function(b,d,c){var a=this;this.messaging.getService("naming-rpc",function(e){e.get(function(f){if(f.status=="success"){d.call(c,false,Ext.create(a.CLASS_MAP[a.bucket],a.bucket,f.value._key,f.value.data,a.messaging))}else{d.call(c,true,null)}},a.bucket,b)},this)},find:function(d,f,c,e,b){var a=this;this.messaging.getService("naming-rpc",function(g){g.find(function(h){if(h.status=="success"){var k=[];for(var j=0;j<h.value.length;j++){k.push(Ext.create(a.CLASS_MAP[a.bucket],a.bucket,h.value[j]._key,h.value[j].data,a.messaging))}e.call(b,false,k)}else{e.call(b,true,null)}},a.bucket,d,f,c)},this)}});Ext.define("Ext.io.App",{extend:"Ext.io.Entity",statics:{getCurrent:function(c,a){var b=Ext.util.Cookie.getItem("app.id");if(!b){c.call(a,{message:"No active apps."},null)}new Ext.io.Entities("Apps",Ext.io.messaging).get(b,c,a)}},constructor:function(d,b,c,a){this.superclass.constructor.call(this,d,b,c,a)},getGroup:function(b,a){this.getSingleLink("Realms",null,null,"Ext.io.Group",b,a)},getQueue:function(a,c,b){this.messaging.getQueue(a.name,c,b)},getStore:function(a,c,b){console.log("JCM return Ext.Store")},findDevices:function(b,c,a){this.findRelatedEntities("Apps",this.key,null,b,"Ext.io.Device",function(e,d){if(e){c.call(a,e,null)}else{c.call(a,null,d)}})},getLocalStores:function(){var a=new Ext.data.Store({model:"Sencha.ClientDatabaseDirectory.Model",storeId:"Ext.data.SyncDatabaseDirectory.store"});a.filterBy(function(b){return b.get("local")});return a.getRange()},getRemoteStores:function(){var a=new Ext.data.Store({model:"Sencha.ClientDatabaseDirectory.Model",storeId:"Ext.data.SyncDatabaseDirectory.store"});a.filterBy(function(b){return b.get("remote")});return a.getRange()},});Ext.define("Ext.io.Device",{extend:"Ext.io.Entity",statics:{getCurrent:function(c,a){var b=Ext.util.Cookie.getItem("device.id");if(!b){c.call(a,{message:"Device ID not found"},null)}else{Ext.create("Ext.io.Entities","Instances",Ext.io.messaging).get(b,c,a)}}},constructor:function(d,b,c,a){this.superclass.constructor.call(this,d,b,c,a)},getApp:function(b,a){this.getSingleLink("Versions",this.data.version,null,"Ext.io.Entity",function(d,c){if(d){b(d,null)}else{c.getSingleLink("Apps",null,"Ext.io.App",b,a)}},this)},getUser:function(b,a){this.getSingleLink("Users",null,null,"Ext.io.User",b,a)},send:function(b,c,a){this.messaging.transport.sendToClient(this.key,b,c,a)},receive:function(b,a){this.messaging.transport.setListener("courier",function(c){b.call(a,c.from,c.msg)},this)}});Ext.define("Ext.io.User",{extend:"Ext.io.Entity",statics:{getCurrent:function(c,b){var a=Ext.util.Cookie.getItem("user.id");if(!a){c.call(b,{message:"User not logged in."},null)}else{Ext.create("Ext.io.Entities","Users",Ext.io.messaging).get(a,c,b)}},getLocalStores:function(){var a=new Ext.data.Store({model:"Sencha.ClientDatabaseDirectory.Model",storeId:"Ext.data.SyncDatabaseDirectory.store"});a.filterBy(function(b){return b.get("local")});return a.getRange()}},constructor:function(d,b,c,a){this.superclass.constructor.call(this,d,b,c,a);this.userQueueName=d+"/"+b},getDevices:function(b,a){this.getRelatedEntities("Instances",null,"Ext.io.Device",b,a)},getGroup:function(b,a){this.getSingleLink("Realms",this.data.realm,null,"Ext.io.Group",b,a)},getStore:function(a,c,b){console.log("JCM return Ext.Store")},send:function(b,c,a){this.messaging.pubsub.publish(this.userQueueName,b,c,a)},receive:function(c,b,a){this.messaging.pubsub.subscribe(this.userQueueName,c,b,a)}});Ext.define("Ext.io.Group",{extend:"Ext.io.Entity",statics:{getCurrent:function(c,b){var a=Ext.util.Cookie.getItem("group.id");if(!a){c.call(b,{message:"Group not found"},null)}else{Ext.create("Ext.io.Entities","Realms",Ext.io.messaging).get(a,c,b)}}},constructor:function(d,b,c,a){this.superclass.constructor.call(this,d,b,c,a)},findUsers:function(b,c,a){this.findRelatedEntities("Users",this.key,null,b,"Ext.io.User",c,a)},register:function(c,d,b){var a=this;this.messaging.getService("authorization",function(e){e.realmRegister(function(f){if(f.status=="success"){d.call(b,false,Ext.create("Ext.io.User",f.value._bucket,f.value._key,f.value.data,a.messaging))}else{d.call(b,true,null)}},a.key,c)},this)},authenticate:function(b,c,a){Ext.io.AuthStrategies.strategies.digest(this,b,c,a)},getApp:function(b,a){Ext.io.App.getCurrent(b,a)}});Ext.data.SyncStore=Ext.extend(Object,{asynchronous:false,constructor:function(a,d,b){Ext.data.utilities.check("SyncStore","constructor","config",a,["database_name","localStorageProxy"]);this.local=a.localStorageProxy;var c=this.local.getIds().length>0;this.readConfig("definition",function(e){if(c&&!e){console.log("Error: Tried to use an existing localstore,",a.id,", as a syncstore.");d.call(b,{r:"error"})}else{this.readConfig("index",function(f){this.index=f;this.readConfig("csiv",function(g){this.csiv=g?new Ext.data.CSIV().decode(g):undefined;if(!this.index||!this.csiv){this.reindex(function(){d.call(b,{r:"ok",store:this})},this)}else{d.call(b,{r:"ok",store:this})}},this)},this)}},this)},create:function(b,d,c){var a=Ext.create("Ext.data.Operation",{records:b});this.local.create(a,d,c)},read:function(c,d,b){var a=Ext.create("Ext.data.Operation",{action:"read",id:c});this.local.read(a,function(f){var e;if(f.resultSet.count==1){e=f.resultSet.records[0];Ext.apply(e,Ext.data.SyncModel)}else{}d.call(b,e)},this)},update:function(b,d,c){var a=Ext.create("Ext.data.Operation",{action:"update",records:b});this.local.update(a,d,c)},destroy:function(d,f,c){if(Ext.isArray(d)){Ext.data.array.forEachAsync(d,function(j,g,h){this.destroy(j,g,h)},this,f,c)}else{var e={};e[Ext.data.SyncModel.OID]=d;var b=[new this.local.model(e)];var a=Ext.create("Ext.data.Operation",{action:"destroy",records:b});this.local.destroy(a,f,c)}},clear:function(b,a){this.local.clear();this.index={};this.removeConfig("index",function(){this.removeConfig("csiv",b,a)},this)},setModel:function(a,b){this.model=a;this.local.setModel(a,b)},readConfig:function(c,e,a){var b=this.local.getStorageObject().getItem(this.local.id+"-"+c);var d=b?Ext.decode(b):{};e.call(a,d)},writeConfig:function(b,c,d,a){this.local.getStorageObject().setItem(this.local.id+"-"+b,Ext.encode(c));d.call(a,c)},removeConfig:function(b,c,a){this.local.getStorageObject().removeItem(this.local.id+"-"+b);c.call(a)},updateIDIndex:function(d,b,c,a){if(!c){throw"ERROR - SyncStore - updateIDIndex - no callback provided"}this.index[d]=b;this.writeConfig("index",this.index,c,a)},lookupIDIndex:function(d,c,a){if(!c){throw"ERROR - SyncStore - lookupIDIndex - no callback provided"}var b=this.index[d];c.call(a,b)},getIndex:function(b,a){b.call(a,this.index)},setIndex:function(a,c,b){if(a){this.index=a;this.writeConfig("index",this.index,c,b)}else{c.call(b)}},getCSIndex:function(b,a){b.call(a,this.csiv)},setCSIndex:function(b,c,a){if(b){this.csiv=b;this.writeConfig("csiv",this.csiv.encode(),c,a)}else{c.call(a)}},oidsFrom:function(a){var b=this.csiv.oidsFrom(a);return b},reindex:function(b,a){this.index={};this.csiv=new Ext.data.CSIV();this.forEachRecord(function(c){var d=c.data[Ext.data.SyncModel.OID];var e=c.data[Ext.data.SyncModel.STATE];this.forEachCS(e,function(f){this.csiv.add(f,d)},this);this.index[c.data.id]=d},this,b,a)},forEachCS:function(b,d,a){for(name in b){if(b.hasOwnProperty(name)){var c=b[name];if(typeof c==="string"){d.call(a,new Ext.data.CS(c))}else{d.call(a,new Ext.data.CS(c[0]));this.forEachCS(d,a,c[1])}}}},readValue:function(a,d,b){var c=this.local.getStorageObject().getItem(a);d.call(b,c)},writeValue:function(a,c,d,b){this.local.getStorageObject().setItem(a,c);d.call(b)},forEachRecord:function(e,d,b,c){var a=Ext.create("Ext.data.Operation",{action:"read",});this.local.read(a,function(h){var g=h.resultSet.records;var j,f=g.length;for(j=0;j<f;j++){e.call(d,g[j])}},this);b.call(c)},});Ext.data.ClientDatabaseDirectoryModel=Ext.define("Sencha.ClientDatabaseDirectory.Model",{extend:"Ext.data.Model",fields:[{name:"key",type:"string"},{name:"database_name",type:"string"},{name:"system_name",type:"string"},{name:"generation",type:"int"},{name:"replica_number",type:"int"},{name:"local",type:"boolean"},{name:"remote",type:"boolean"},],idProperty:"database_name",proxy:{id:"sencha-io-database-directory",type:"localstorage"}});Ext.data.ClientDatabaseDirectory=Ext.extend(Object,{store:undefined,constructor:function(a){this.store=new Ext.data.Store({model:"Sencha.ClientDatabaseDirectory.Model",});this.store.load()},getDatabaseDefinition:function(a){var b=this.store.findRecord("database_name",a);return b?new Ext.data.DatabaseDefinition(b.data):undefined},putDatabaseDefinition:function(a,d,b){var c=this.store.findRecord("database_name",a.database_name);if(c){c.set(a);c.save()}else{this.store.add(a)}this.store.sync()},});Ext.data.SyncProxy=Ext.extend(Ext.data.Proxy,{definition:undefined,csv:undefined,generator:undefined,model:undefined,store:undefined,idProperty:undefined,idDefaultProperty:undefined,constructor:function(a,c,b){Ext.data.utilities.check("SyncProxy","constructor","config",a,["store","database_name","key"]);this.store=a.store;this.getSystemName(function(d){a.system_name=d;Ext.data.utilities.apply(this,["readConfig_DatabaseDefinition","readConfig_CSV","readConfig_Generator"],[a],function(){c.call(b,{r:"ok",proxy:this})},this)},this)},create:function(a,c,b){new Ext.data.Transaction(this,function(e){a.records.forEach(function(f){f.setCreateState(e);if(f.get(this.idProperty)===this.idPropertyDefaultValue){var g=f.getPair(Ext.data.SyncModel.OID);f.data[this.idProperty]=g.v}},this);var d=this.encodeRecords(a.records);e.create(d);this.indexCreatedRecords(e,a.records);e.commit(function(){a.records.forEach(function(f){f.needsAdd=false;f.phantom=false},this);a.setSuccessful();a.setCompleted();this.doCallback(c,b,a)},this)},this)},read:function(b,e,d){function c(g,f){f=this.decodeRecords(f);f=Ext.data.array.select(f,function(h){return h.isNotDestroyed()&&!h.phantom},this);g.resultSet=Ext.create("Ext.data.ResultSet",{records:f,total:f.length,loaded:true});g.setSuccessful();g.setCompleted()}if(b.id!==undefined){this.store.lookupIDIndex(b.id,function(f){this.store.read(f,function(g){c.call(this,b,[g]);this.doCallback(e,d,b)},this)},this)}else{if(b[Ext.data.SyncModel.OID]!==undefined){this.store.read(b[Ext.data.SyncModel.OID],function(f){c.call(this,b,[f]);this.doCallback(e,d,b)},this)}else{var a=[];this.forEachRecord(false,function(g,f,h){a.push(g);f.call(h)},this,function(){c.call(this,b,a);this.doCallback(e,d,b)},this)}}},update:function(a,c,b){new Ext.data.Transaction(this,function(e){a.records.forEach(function(f){f.setUpdateState(e)},this);var d=this.encodeRecords(a.records);e.update(d);e.commit(function(){a.setSuccessful();a.setCompleted();this.doCallback(c,b,a)},this)},this)},destroy:function(a,c,b){new Ext.data.Transaction(this,function(e){var d=[];Ext.data.array.forEachAsync(a.records,function(g,f,j){g.setDestroyState(e);var h=g.oid();if(!h){var k=g.data[this.idProperty];e.lookupIDIndex(k,function(l){if(l){g.data[Ext.data.SyncModel.OID]=l;d.push(g)}f.call(j)},this)}else{d.push(g);f.call(j)}},this,function(){d=this.encodeRecords(d);e.update(d);this.indexDestroyedRecords(e,a.records);e.commit(function(){a.setSuccessful();a.setCompleted();a.action="destroy";this.doCallback(c,b,a)},this)},this)},this)},clear:function(b,a){this.store.clear(function(){this.store.removeConfig("definition",function(){this.store.removeConfig("csv",function(){this.store.removeConfig("generator",b,a)},this)},this)},this)},reset:function(b,a){this.store.clear(function(){this.store.removeConfig("csv",function(){readConfig_CSV({},b,a)},this)},this)},setModel:function(b,d){this.model=b;this.idProperty=this.model.prototype.idProperty;var a=this.model.prototype.fields.items,e=a.length,f,c;for(c=0;c<e;c++){f=a[c];if(f.name===this.idProperty){this.idPropertyDefaultValue=f.defaultValue}}this.definition.set({idProperty:this.idProperty,idPropertyDefaultValue:this.idPropertyDefaultValue},function(){},this);Ext.apply(b.prototype,Ext.data.SyncModel);this.storageModel=b.prototype.createReplStorageModel(this.modelName);this.store.setModel(this.storageModel,d)},replicaNumber:function(){return this.generator.r},addReplicaNumbers:function(a,c,b){this.csv.addReplicaNumbers(a);this.writeConfig_CSV(this.csv,c,b)},setReplicaNumber:function(c,d,b){if(!d){throw"ERROR - SyncProxy - setReplicaNumber - no callback provided."}var a=this.replicaNumber();console.log("SyncProxy.setReplicaNumber from",a,"to",c);this.changeReplicaNumber(a,c,function(){this.definition.setReplicaNumber(c,function(){this.csv.changeReplicaNumber(a,c);this.generator.setReplicaNumber(c);this.writeConfig_Generator(this.generator,function(){this.writeConfig_CSV(this.csv,d,b)},this)},this)},this)},changeReplicaNumber:function(a,c,d,b){console.log("SyncProxy.changeReplicaNumber from",a,"to",c);console.log(this.csv.to_s());if(!d){throw"ERROR - SyncProxy - changeReplicaNumber - no callback provided."}this.forEachRecord(false,function(g,e,j){var f=g.oid();if(g.changeReplicaNumber(a,c)){var h=this.encodeRecords([g]);this.store.create(h,function(){this.store.destroy(f,e,j)},this)}else{e.call(j)}},this,function(){this.store.reindex(d,b)},this)},getUpdates:function(b,f,e){b.addReplicaNumbers(this.csv);var d=this.csv.dominated(b);var a=d.length;console.log("getUpdates from",b.to_s()," dominated=",Ext.encode(d));if(a==0){f.call(e,new Ext.data.Updates(),undefined)}else{this.start=new Date().getTime();var c=this.store.oidsFrom(b);console.log("getUpdates oids",Ext.encode(c));this.getUpdates_candidateList(b,c,function(h,g){this.getUpdates_done(b,h,f,e)},this)}},getUpdates_done:function(b,f,g,e){var a=new Ext.data.CSV();a.addCSV(this.csv.dominant(b));var d=new Date().getTime();var c=d-this.start;if(c>10){console.log("getUpdates",f.length,"updates took",c,"ms")}g.call(e,new Ext.data.Updates(f),a)},getUpdates_fullScan:function(a,d,b){var c=[];this.forEachRecord(false,function(f,e,g){c=c.concat(f.getUpdates(a));e.call(g)},this,function(){d.call(b,c)},this)},getUpdates_candidateList:function(a,b,e,c){var d=[];this.forEachRecordFromOids(b,function(g,f,h){d=d.concat(g.getUpdates(a));f.call(h)},this,function(){e.call(c,d)},this)},putUpdates:function(b,c,d,a){if(b.isEmpty()){new Ext.data.Transaction(this,function(e){e.updateCSV(c);e.commit(function(){d.call(a,{r:"ok"})},this)},this)}else{this.start=new Date().getTime();new Ext.data.Transaction(this,function(f){var e=new Ext.data.CSV();if(this.store.asynchronous){b.forEachAsync(function(j,g,h){this.applyUpdate(f,j,function(){e.addCS(j.c);g.call(h)},this)},this,function(){this.putUpdates_done(f,b,c,e,d,a)},this)}else{b.forEach(function(g){this.applyUpdate(f,g,function(){},this);e.addCS(g.c)},this);this.putUpdates_done(f,b,c,e,d,a)}},this)}},putUpdates_done:function(b,d,e,a,f,c){b.updateCSV(a);b.updateCSV(e);b.commit(function(m,j){m=Ext.data.array.select(m,Ext.data.SyncModel.isNotDestroyed);var g=Ext.data.array.partition(j,Ext.data.SyncModel.isDestroyed);var h=g[0];j=g[1];m=this.decodeRecords(m);j=this.decodeRecords(j);h=this.decodeRecords(h);var l=new Date().getTime();var k=l-this.start;if(k>10){console.log("putUpdates took",k,"ms")}f.call(c,{r:"ok",created:m,updated:j,removed:h})},this)},applyUpdate:function(a,e,d,b,c){a.read(e.i,function(f){if(f){var g=f.ref();if(g&&e.p[0]!="_"){if(e.i===g){console.log("Error - applyUpdate - Infinite loop following reference. ",g)}else{e.i=g;this.applyUpdate(a,e,d,b,g)}}else{if(e.p===this.idProperty){this.applyUpdateToRecordForUniqueID(a,f,e,d,b)}else{this.applyUpdateToRecord(a,f,e);d.call(b)}}}else{this.applyUpdateCreatingNewRecord(a,e);d.call(b)}},this)},applyUpdateCreatingNewRecord:function(b,c){var a;if(c.p===Ext.data.SyncModel.OID){a=this.createNewRecord(b,c.v,c.c)}else{a=this.createNewRecord(b,c.i,c.i);a.setPair(b,c.p,c.v,c.c)}b.create([a])},applyUpdateToRecordForUniqueID:function(b,a,e,d,c){if(a.data[e.p]===e.v){this.applyUpdateToRecordForUniqueId(b,a,e);d.call(c)}else{b.lookupIDIndex(e.v,function(f){if(f){this.readById(b,e.v,f,function(h){this.applyUpdateToRecordForUniqueId(b,a,e);var k=new Ext.data.CS(a.oid());var l=new Ext.data.CS(h.oid());var g,j;if(k.greaterThan(l)){g=h;j=a}else{g=a;j=h}this.resolveUniqueIDConflict(b,g,j);b.updateIDIndex(e.v,g.oid());d.call(c)},this)}else{this.applyUpdateToRecordForUniqueId(b,a,e);d.call(c)}},this)}},applyUpdatesToRecord:function(d,b,e){var a=e.length;for(var c=0;c<a;c++){this.applyUpdateToRecord(d,b,e[c])}},applyUpdateToRecordForUniqueId:function(b,a,e){var d=a.data[e.p];var c=e.v;if(this.applyUpdateToRecord(b,a,e)){b.updateIDIndex(c,a.oid());if(d){b.updateIDIndex(d,undefined)}}},applyUpdateToRecord:function(b,a,c){if(a.putUpdate(b,c)){b.update([a]);return true}else{return false}},readById:function(a,e,c,d,b){a.lookupIDIndex(e,function(f){a.read(f,function(g){if(g){d.call(b,g)}else{console.log("ERROR - SyncProxy - applyUpdateToUniqueID - ID Index refers to an non-existant object:",e,"=>",f,"(This should not be possible.)")}},this)},this)},resolveUniqueIDConflict:function(c,b,a){var d=this.updatesForMergeRecords(b,a);this.applyUpdatesToRecord(c,b,d);var d=this.updatesForMakeReference(c,a,b);this.applyUpdatesToRecord(c,a,d)},updatesForMergeRecords:function(d,b){var a=d.getCSV();var f=b.getUpdates(a);var e=[];var c=d.oid();f.forEach(function(g){if(g.p!==this.idProperty&&g.p!==Ext.data.SyncModel.OID){g.i=c;e.push(g)}},this);return e},updatesForMakeReference:function(e,b,a){if(b.oid()===a.oid()){console.log("updatesForMakeReference",b.data,a.data);throw"Error - SyncProxy - Tried to create reference to self."}var d=e.generateChangeStamp();var c=e.generateChangeStamp();var f=[{i:b.oid(),p:Ext.data.SyncModel.REF,v:a.oid(),c:d},{i:b.oid(),p:Ext.data.SyncModel.TOMBSTONE,v:c.to_s(),c:c}];return f},createNewRecord:function(b,d,c){var a=new this.storageModel();a.phantom=false;Ext.apply(a,Ext.data.SyncModel);a.setPair(b,Ext.data.SyncModel.OID,d,c);return a},indexCreatedRecords:function(b,a){a.forEach(function(c){var d=c.data[this.idProperty];if(d){b.updateIDIndex(d,c.data[Ext.data.SyncModel.OID])}},this)},indexDestroyedRecords:function(b,a){a.forEach(function(c){var d=c.data[this.idProperty];if(d){b.updateIDIndex(d,undefined)}},this)},equals:function(a,c,b){if(this.csv.equals(a.csv)){this.hasSameRecords(a,function(d){if(d){a.hasSameRecords(this,c,b)}else{c.call(b,d)}},this)}else{c.call(b,false)}},hasSameRecords:function(a,c,b){this.forEachRecord(false,function(e,d,f){this.store.read(e.oid(),function(g){if(g){r=e.equals(g);if(r){d.call(f)}else{console.log("hasSameRecords - false - ",this.replicaNumber(),a.replicaNumber());c.call(b,false)}}else{console.log("hasSameRecords - false - ",this.replicaNumber(),a.replicaNumber());c.call(b,false)}},this)},this,function(){c.call(b,true)},this)},console_log:function(b,c,a){console.log("==== ",b);this.forEachRecord(false,function(e,d,f){console.log(Ext.encode(e.data));d.call(f)},this,function(){console.log("----");this.store.getIndex(function(d){console.log(d);this.store.getCSIndex(function(e){console.log(e.to_s());console.log("====");c.call(a)},this)},this)},this)},forEachRecord:function(j,f,b,e,c){var d=this.model;var a=new Date().getTime();if(this.store.asynchronous){this.store.forEachRecord(function(l,k,m){if(j||(!j&&!this.isSystemRecord(l))){f.call(b,new d(l.data),k,m)}else{k.call(m)}},this,function(){var l=new Date().getTime();var k=l-a;if(k>10){console.log("SyncProxy.forEachRecord took",l-a,"ms")}e.call(c)},this)}else{this.store.forEachRecord(function(k){if(j||(!j&&!this.isSystemRecord(k))){f.call(b,new d(k.data),function(){})}},this,e,c);var h=new Date().getTime();var g=h-a;if(g>10){console.log("SyncProxy.forEachRecord took",h-a,"ms")}}},forEachRecordFromOids:function(b,g,f,d,e){if(this.store.asynchronous){Ext.data.array.forEachAsync(b,function(k,h,j){this.store.read(k,function(l){g.call(f,l,h,j)},this)},this,d,e)}else{var c,a=b.length;for(c=0;c<a;c++){this.store.read(b[c],function(h){g.call(f,h,function(){})},this)}d.call(e)}},isSystemRecord:function(b){var a=b.data[Ext.data.SyncModel.MODEL];return a!==undefined&&a!==""&&a.indexOf("Ext.data.",0)===0},encodeRecords:function(a){var b=this.storageModel;return Ext.data.array.collect(a,function(){var c=new b(this.data);c.internalId=this.internalId;c.phantom=false;return c})},decodeRecords:function(a){var b=this.model;return Ext.data.array.collect(a,function(){var c=new b(this.data);c.internalId=this.internalId;c.phantom=false;return c})},getSystemName:function(b,a){this.store.readValue("sencha.io.client.uuid",function(c){if(c){b.call(a,c)}else{var c=Ext.util.UUIDGenerator.generate();console.log("Created new Sencha Sync System Name:",c);this.store.writeValue("sencha.io.client.uuid",c,function(){b.call(a,c)},this)}},this)},readConfig_DatabaseDefinition:function(b,e,d){var c={key:b.key,system_name:b.system_name,generation:(b.definition?b.definition.generation:0)||0,replica_number:(b.definition?b.definition.replica_number:0)||0};var a={database_name:b.database_name,replica_type:b.replica_type};this.readConfig(Ext.data.DatabaseDefinition,"definition",c,a,function(g,f){this.definition=f;e.call(d,g,f)},this)},readConfig_Generator:function(b,d,c){var a={r:this.definition.replica_number,clock:b.clock};this.readConfig(Ext.data.CSGenerator,"generator",{},a,function(e,f){this.generator=f;d.call(c,e,f)},this)},readConfig_CSV:function(a,c,b){this.readConfig(Ext.data.CSV,"csv",{},{},function(e,d){this.csv=d;c.call(b,e,d)},this)},writeConfig_Generator:function(b,c,a){if(b){this.store.writeConfig("generator",b.as_data(),c,a)}else{c.call(a)}},writeConfig_CSV:function(a,c,b){if(a){this.store.writeConfig("csv",a.as_data(),c,b)}else{c.call(b)}},writeConfig:function(d,a,c,b){this.store.writeConfig(d,a.as_data(),function(e){c.call(b)},this)},readConfig:function(d,f,b,a,e,c){this.store.readConfig(f,function(k){var j=(k===undefined)?"created":"ok";if(b!==undefined){if(k===undefined){k=b}else{for(var g in b){if(k[g]===undefined){k[g]=b[g];changed=true}}}}if(a!==undefined){if(k===undefined){k=a}else{for(var g in a){if(k[g]!==a[g]){k[g]=a[g];changed=true}}}}var h=this;k.config_id=f;k.write_fn=function(l,m,n){h.writeConfig.call(h,f,l,m,n)};e.call(c,j,new d(k))},this)},doCallback:function(c,b,a){if(typeof c=="function"){c.call(b||this,a)}},us:function(b){var c=Ext.isArray(b.p)?b.p.join():b.p;var a=b.v;switch(typeof b.v){case"object":a=Ext.encode(b.v)}return"("+b.i+" . "+c+" = '"+a+"' @ "+b.c.to_s()+")"},});Ext.data.SyncDatabaseDirectory=Ext.create("Ext.data.ClientDatabaseDirectory");Ext.define("Ext.data.proxy.SyncStorage",{extend:"Ext.data.proxy.Client",alias:"proxy.syncstorage",proxyLock:true,constructor:function(a,d,b){a.url=a.url||"http://sync.sencha.io/";Ext.data.utilities.check("SyncStorageProxy","constructor","config",a,["id","url","key"]);a.database_name=a.id;a.datastore_name="data";this.callParent([a]);a.definition=Ext.data.SyncDatabaseDirectory.getDatabaseDefinition(a.database_name);a.localStorageProxy=a.localStorageProxy||Ext.create("proxy.localstorage",{id:a.database_name});this.localProxy=a.localStorageProxy;var c=function(e){this.localStore=e.store;this.protocol=new Ext.data.Protocol(e);new Ext.data.SyncProxy(e,function(f){if(f.r==="ok"){this.remoteProxy=f.proxy;Ext.data.utilities.delegate(this,f.proxy,["create","read","update","destroy","setModel"]);this.setDatabaseDefinitionLocal(true);this.proxyLock=false}if(d){d.call(b,{r:"ok",proxy:this})}},this)};if(a.store){c.call(this,a)}else{new Ext.data.SyncStore(a,function(e){if(e.r==="ok"){a.store=e.store;c.call(this,a)}else{if(d){d.call(b,e)}}},this)}},sync:function(a,d,b){if(this.protocol){a.fireEvent("beforesync");if(this.proxyLock){console.log("Warning: Tried to access proxy, whilst another operation was in progress.")}else{this.proxyLock=true;try{this.do_sync(a,function(e){this.proxyLock=false;a.fireEvent("aftersync");if(d){d.call(b,e)}},this)}catch(c){this.proxyLock=false;console.log(c);console.log(c.stack);throw c}}}else{console.log("Error: Tried to access proxy, but it has been cleared.")}},do_sync:function(a,d,c){var b=Ext.data.Store.superclass.sync.call(a);if(b.added.length>0){a.fireEvent("add",this,b.added,0)}a.removed=[];this.protocol.sync(this.remoteProxy,function(k){console.log("sync",k.r);switch(k.r){case"ok":this.setDatabaseDefinitionRemote(true);break;case"again":this.updateDatabaseDefinition();this.do_sync(a,d,c);break}var j=k.created;var f=k.updated;var g=k.removed;if(j&&j.length>0){a.data.addAll(j);a.fireEvent("add",this,j,0)}if(f&&f.length>0){a.data.addAll(f);a.fireEvent("update",this,f)}if(g&&g.length>0){var e=g.length;for(var h=0;h<e;h++){var m=g[h].getId();a.data.removeAt(a.data.findIndexBy(function(l){return l.getId()===m}))}a.fireEvent("remove",this,g)}d.call(c,{r:k.r})},this)},clear:function(){if(this.remoteProxy){this.proxyLock=true;this.setDatabaseDefinitionLocal(false);this.remoteProxy.clear(function(){delete this.localProxy;delete this.remoteProxy;delete this.protocol},this)}else{console.log("Error: Tried to clear a proxy, but it has been cleared.")}},setDatabaseDefinitionLocal:function(a){this.remoteProxy.definition.local=a;Ext.data.SyncDatabaseDirectory.putDatabaseDefinition(this.remoteProxy.definition)},setDatabaseDefinitionRemote:function(a){this.remoteProxy.definition.remote=a;Ext.data.SyncDatabaseDirectory.putDatabaseDefinition(this.remoteProxy.definition)},updateDatabaseDefinition:function(){Ext.data.SyncDatabaseDirectory.putDatabaseDefinition(this.remoteProxy.definition)},});Ext.data.array={select:function(b,d,c){var e=[];if(b){b.forEach(function(a){if(a!==undefined&&d.call(c||a,a)){e.push(a)}})}return e},partition:function(d,k,h){var e=[],c=[];if(d){var f,b=d.length;for(var g=0;g<b;g++){f=d[g];if(f!==undefined){if(k.call(h||f,f)){e.push(f)}else{c.push(f)}}}}return[e,c]},index:function(c,g,f){if(c){var d,b=c.length;for(var e=0;e<b;e++){d=c[e];if(g.call(f||d,d)){return e}}}},collect:function(b,d,c){var e=[];if(b){b.forEach(function(a){if(a!==undefined){e.push(d.call(c||a,a))}})}return e},includes:function(c,d){if(c){var b=c.length;for(var e=0;e<b;e++){if(c[e]===d){return true}}}return false},remove:function(c,d){var g=[];if(c){var e,b=c.length;for(var f=0;f<b;f++){e=c[f];if(e!==d){g.push(e)}}}return g},any:function(c,g,f){var d,b=c.length;for(var e=0;e<b;e++){d=c[e];if(g.call(f||d,d)){return true}}return false},all:function(c,g,f){var d,b=c.length;for(var e=0;e<b;e++){var d=c[e];if(!g.call(f||d,d)){return false}}return true},unique:function(c){var f={},d,b=c.length,e=[];for(d=0;d<b;d+=1){f[c[d]]=c[d]}for(d in f){e.push(f[d])}return e},minus:function(e,c){var h={},f,d=e.length,g=[];for(f=0;f<d;f+=1){h[e[f]]=e[f]}d=c.length;for(f=0;f<d;f+=1){delete h[c[f]]}for(f in h){g.push(h[f])}return g},forEachAsync:function(d,k,j,c,h){if(!k){throw"ERROR - Ext.data.Array - forEachAsync - no 'each' function provided"}if(!c){throw"ERROR - Ext.data.Array - forEachAsync - no 'done' function provided"}var e=0;var b=d.length;var g=function g(){if(e<b){var a=d[e];var f=j||a;e=e+1;k.call(f,a,g,f)}else{c.call(h)}};g()},forEachYielding:function(d,k,j,c,h){var e=0;var b=d.length;function g(){if(e<b){k.call(j,d[e],function(){e=e+1;setTimeout(g,20)},this)}else{c.call(h)}}g()}};Ext.data.utilities={delegate:function(c,b,a){if(b===undefined){throw"Error - Tried to delegate '"+a+"' to undefined instance."}a.forEach(function(e){var d=b[e];if(d===undefined){throw"Error - Tried to delegate undefined method '"+e+"' to "+b}c[e]=function(){return d.apply(b,arguments)}})},apply:function(b,d,c,e,f){var g=true;Ext.data.array.forEachAsync(d,function(j,a,h){if(g){c.push(a);c.push(h);g=false}b[j].apply(b,c)},b,e,f)},copy:function(d,b,a){var c=false;a.forEach(function(g){var f=d[g];var e=b[g];if(f!==undefined&&f!==e){b[g]=f;c=true}});return c},copyIfUndefined:function(d,b,a){var c=false;a.forEach(function(g){var f=d[g];var e=b[g];if(f!==undefined&&e===undefined){b[g]=f;c=true}});return c},check:function(f,c,e,a,b){if(a===undefined){var d="Error - "+f+"."+c+" - "+e+" not provided.";console.log(d);throw d}else{b.forEach(function(j){var h=a[j];if(h===undefined){var g="Error - "+f+"."+c+" - "+e+"."+j+" not provided.";console.log(g);throw g}})}},minus:function(d,c){var f,e={};for(f in d){if(d.hasOwnProperty(f)){if(c[f]===undefined){e[f]=d[f]}}}return e},intersection:function(d,c){var f,e={};for(f in d){if(d.hasOwnProperty(f)){if(c[f]!==undefined){e[f]=d[f]}}}return e},};Ext.data.Clock=Ext.extend(Object,{constructor:function(){this.epoch=new Date(2011,0,1)},now:function(){return this.ms_to_s(new Date().getTime()-this.epoch)},ms_to_s:function(a){return Math.floor(a/1000)},});Ext.data.Config=Ext.extend(Object,{config_id:undefined,write_fn:undefined,_id:undefined,constructor:function(a){this.config_id=a.config_id;this.write_fn=a.write_fn;this._id=a._id},set:function(a){this._id=a._id},to_s:function(a){return this.config_id+": "+Ext.encode(this)},as_data:function(a){a.id=this.config_id;a._id=this._id;a[Ext.data.SyncModel.OID]=a[Ext.data.SyncModel.OID]||this.config_id;return a},writeAndCallback:function(b,c,a){if(b){this.write(function(){if(c){c.call(a,this)}},this)}else{if(c){c.call(a,this)}}},write:function(b,a){if(this.write_fn){this.write_fn(this,function(){if(b){b.call(a,this)}},this)}else{if(b){b.call(a,this)}}},});Ext.data.CS=Ext.extend(Object,{r:0,t:0,s:0,constructor:function(a){this.set(a)},set:function(a){if(typeof a==="string"||a instanceof String){this.from_s(a)}else{if(typeof a==="object"){this.r=a.r||0;this.t=a.t||0;this.s=a.s||0}}},changeReplicaNumber:function(a,b){if(this.r==a){this.r=b;return true}return false},greaterThan:function(a){return this.compare(a)>0},lessThan:function(a){return this.compare(a)<0},equals:function(a){return this.compare(a)===0},compare:function(a){var b=this.t-a.t;if(b==0){b=this.s-a.s;if(b==0){b=this.r-a.r}}return b},cs_regex:/(\d+)-(\d+)-?(\d+)?/,from_s:function(b){var a=b.match(this.cs_regex);if(a&&a.length>0){this.r=parseInt(a[1]);this.t=parseInt(a[2]);this.s=a[3]?parseInt(a[3]):0}else{throw"Error - CS - Bad change stamp '"+b+"'."}return this},to_s:function(){return this.r+"-"+this.t+(this.s>0?"-"+this.s:"")}});Ext.data.CSGenerator=Ext.extend(Object,{r:undefined,t:undefined,s:undefined,clock:undefined,local_offset:undefined,global_offset:undefined,constructor:function(a){this.set(a)},set:function(a){if(a){this.clock=a.clock||new Ext.data.Clock();this.r=a.r;this.t=a.t||this.clock.now();this.s=a.s||-1;this.local_offset=a.local_offset||0;this.global_offset=a.global_offset||0}},generateChangeStamp:function(){var a=this.clock.now();this.update_local_offset(a);this.s+=1;if(this.s>255){this.t=a;this.local_offset+=1;this.s=0}return new Ext.data.CS({r:this.r,t:this.global_time(),s:this.s})},seenCSV:function(a){return this.seenChangeStamp(a.maxChangeStamp())},seenChangeStamp:function(a){var c=false;if(a){var b=this.clock.now();if(b>this.t){c=this.update_local_offset(b)}c=c||this.update_global_offset(a)}return c},setReplicaNumber:function(b){var a=this.r!==b;this.r=b;return a},update_local_offset:function(d){var c=false;var e=d-this.t;if(e>0){var b=this.global_time();this.t=d;if(e>this.local_offset){this.local_offset=0}else{this.local_offset-=e}var a=this.global_time();if(a>b){this.s=-1}c=true}else{if(e<0){this.t=d;this.local_offset+=-e;c=true}}return c},update_global_offset:function(c){var f=false;var d=new Ext.data.CS({r:this.r,t:this.global_time(),s:this.s+1});var e=d.t;var h=d.s;var a=c.t;var b=c.s;if(a==e&&b>=h){this.s=b;f=true}else{if(a>e){var g=a-e;if(g>0){this.global_offset+=g;this.s=b;f=true}}}return f},global_time:function(){return this.t+this.local_offset+this.global_offset},as_data:function(){var a={r:this.r,t:this.t,s:this.s,local_offset:this.local_offset,global_offset:this.global_offset,id:"generator"};a[Ext.data.SyncModel.MODEL]="Ext.data.CSGenerator";return a},});Ext.data.CSV=Ext.extend(Object,{v:undefined,constructor:function(a){this.v={};if(a===undefined){}else{if(a instanceof Ext.data.CSV){this.addX(a)}else{this.addX(a.v)}}},get:function(a){if(a instanceof Ext.data.CS){return this.v[a.r]}else{return this.v[a]}},setReplicaNumber:function(a){this.addReplicaNumbers([a])},addReplicaNumbers:function(a){var b=[];if(a instanceof Array){b=Ext.data.array.collect(a,function(c){return this.addX(new Ext.data.CS({r:c}))},this)}else{if(a instanceof Ext.data.CSV){b=Ext.data.array.collect(a,function(c){return this.addX(new Ext.data.CS({r:c.r}))},this)}}return Ext.data.array.includes(b,true)},addX:function(a){var c=false;if(a===undefined){}else{if(a instanceof Ext.data.CSV||a instanceof Array){var b=Ext.data.array.collect(a,this.addX,this);c=Ext.data.array.includes(b,true)}else{if(a instanceof Ext.data.CS){c=this.addCS(a)}else{if(typeof a=="string"||a instanceof String){c=this.addX(new Ext.data.CS(a))}}}}return c},addCS:function(a){var d=false;if(a!==undefined){var c=a.r;var b=this.v[c];if(!b||a.greaterThan(b)){this.v[c]=new Ext.data.CS({r:a.r,t:a.t,s:a.s});d=true}}return d},addCSV:function(a){var c=false;if(a!==undefined){var b=Ext.data.array.collect(a,this.addCS,this);c=Ext.data.array.includes(b,true)}return c},changeReplicaNumber:function(a,c){var b=this.v[a];var d=false;if(b){b.r=c;this.v[a]=undefined;this.v[c]=b;d=true}return d},isEmpty:function(){for(var a in this.v){return false}return true},maxChangeStamp:function(){if(!this.isEmpty()){var a=new Ext.data.CS();this.forEach(function(c){var b=new Ext.data.CS({t:c.t,s:c.s});a=(b.greaterThan(a)?c:a)},this);return a}},minChangeStamp:function(){if(!this.isEmpty()){var a;this.forEach(function(c){if(c.t!=0||c.s!=0){var b=new Ext.data.CS({t:c.t,s:c.s});a=(!a||b.lessThan(a)?c:a)}},this);return a}},intersect:function(a){this.v=Ext.data.array.select(a,function(b){return this.v[b.r]!==undefined},this)},dominates:function(a){return Ext.data.array.any(this.compare(a),function(b){return b>0})},dominated:function(a){return Ext.data.array.select(a,function(b){return this.compare(b)>0},this)},dominant:function(a){return Ext.data.array.select(this,function(b){return a.compare(b)<0},this)},equals:function(a){return Ext.data.array.all(this.compare(a),function(b){return b===0})},compare:function(a){if(a instanceof Ext.data.CS){var c=this.get(a);var b=a;return[c?c.compare(b):-1]}else{if(a instanceof Ext.data.CSV){var d=[];for(i in this.v){var c=this.v[i];if(c instanceof Ext.data.CS){var b=a.get(c);d.push(b?c.compare(b):1)}}return d}else{throw"Error - CSV - compare - Unknown type: "+(typeof a)+": "+a}}return[-1]},forEach:function(c,b){for(var a in this.v){if(this.v.hasOwnProperty(a)){c.call(b||this,this.v[a])}}},encode:function(){return Ext.data.array.collect(this,function(){return this.to_s()}).join(".")},decode:function(a){if(a){this.addX(a.split("."))}return this},to_s:function(a){var b="CSV: ";this.forEach(function(c){b+=c.to_s()+", "},this);return b},as_data:function(){var a={v:Ext.data.array.collect(this,function(){return this.to_s()}),id:"csv"};a[Ext.data.SyncModel.MODEL]="Ext.data.CSV";return a},});Ext.data.CSI=Ext.extend(Object,{map:{},v:[],dirty:false,constructor:function(){this.clear()},clear:function(){this.map={};this.v=[];this.dirty=false},add:function(b,c){var a=this.map[b];if(a){a[c]=true}else{var a={};a[c]=true;this.map[b]=a;this.dirty=true}},remove:function(b,c){var a=this.map[b];if(a){delete a[c];this.dirty=true}},oidsFrom:function(c){var e=[];var d=this.keysFrom(c);var a=d.length;for(var b=0;b<a;b++){e=e.concat(this.oToA(this.map[d[b]]))}return e},keysFrom:function(d){var f=[];var e=this.keys();var a=e.length;for(var c=0;c<a;c++){var b=e[c];if(b>=d){f.push(b)}}return f},encode:function(){var b={};for(var a in this.map){if(this.map.hasOwnProperty(a)&&!this.isEmpty(this.map[a])){b[a]=this.oToA(this.map[a])}}return b},decode:function(b){this.clear();for(var d in b){if(b.hasOwnProperty(d)){var a=b[d];for(var c=0;c<a.length;c++){this.add(d,a[c])}}}return this},keys:function(){if(this.dirty){this.v=[];for(var a in this.map){if(this.map.hasOwnProperty(a)&&!this.isEmpty(this.map[a])){this.v.push(a)}}this.dirty=false}return this.v},isEmpty:function(b){for(var a in b){return false}return true},oToA:function(c){var b=[];if(c){for(var a in c){if(c.hasOwnProperty(a)){b.push(a)}}}return b},to_s:function(){var b="";for(var a in this.map){if(this.map.hasOwnProperty(a)&&!this.isEmpty(this.map[a])){b=b+a+":"+this.oToA(this.map[a])}b=b+", ";csiv}return b},});Ext.data.CSIV=Ext.extend(Object,{v:{},constructor:function(){this.v={}},oidsFrom:function(a){var b=[];a.forEach(function(d){var c=this.v[d.r];if(c){b=b.concat(c.oidsFrom(d.t))}},this);b=Ext.data.array.unique(b);return b},add:function(b,c){var a=this.v[b.r];if(a===undefined){a=this.v[b.r]=new Ext.data.CSI()}a.add(b.t,c)},addArray:function(c,f){var b=c.length;for(var d=0;d<b;d++){var e=c[d];if(e){this.add(c[d],f)}}},addRecord:function(b){var e=b.oid();var c=b.getAllCS();var a=c.length;for(var d=0;d<a;d++){this.add(c[d],e)}},remove:function(b,c){var a=this.v[b.r];if(a){a.remove(b.t,c)}},removeArray:function(c,f){var b=c.length;for(var d=0;d<b;d++){var e=c[d];if(e){this.remove(c[d],f)}}},encode:function(){var b={};for(var a in this.v){if(this.v.hasOwnProperty(a)){b[a]=this.v[a].encode()}}var c={};c.id="csiv";c[Ext.data.SyncModel.MODEL]="Ext.data.CSIV";c.r=b;return c},decode:function(a){this.v={};if(a){for(var b in a.r){if(a.r.hasOwnProperty(b)){this.v[b]=new Ext.data.CSI().decode(a.r[b])}}}return this},to_s:function(){var b="";for(var a in this.v){if(this.v.hasOwnProperty(a)){b=b+a+"=>["+this.v[a].to_s()+"], "}}return b},});Ext.data.DatabaseDefinition=Ext.extend(Ext.data.Config,{key:undefined,database_name:undefined,generation:undefined,system_name:undefined,system_names:{},replica_number:undefined,idProperty:undefined,idPropertyDefaultValue:undefined,version:1,constructor:function(a,c,b){Ext.data.utilities.check("DatabaseDefinition","constructor","config",a,["key","database_name","generation","system_name","replica_number"]);this.set(a);a.config_id="definition";Ext.data.DatabaseDefinition.superclass.constructor.call(this,a)},setReplicaNumber:function(c,d,a){var b=(this.replica_number!=c);this.replica_number=c;this.writeAndCallback(b,d,a)},addSystemName:function(a){this.system_names[a]=true},isKnownOf:function(a){return this.system_name===a||Ext.data.array.includes(this.system_names,a)},set:function(a,d,b){var c=Ext.data.utilities.copy(a,this,["key","database_name","generation","system_name","system_names","replica_number","idProperty","idPropertyDefaultValue","version","_id"]);this.writeAndCallback(c,d,b)},as_data:function(){var a={key:this.key,database_name:this.database_name,generation:this.generation,system_name:this.system_name,system_names:this.system_names,replica_number:this.replica_number,idProperty:this.idProperty,idPropertyDefaultValue:this.idPropertyDefaultValue,version:this.version,};a[Ext.data.SyncModel.MODEL]="Ext.data.DatabaseDefinition";return Ext.data.DatabaseDefinition.superclass.as_data.call(this,a)},encode:function(){return{key:this.key,database_name:this.database_name,generation:this.generation,system_name:this.system_name,replica_number:this.replica_number,idProperty:this.idProperty,idPropertyDefaultValue:this.idPropertyDefaultValue,}},});Ext.data.Protocol=Ext.extend(Object,{constructor:function(b){this.url=b.url;this.database_name=b.id;this.key=b.key;var a=this.url.length;if(this.url[a-1]=="/"){this.url=this.url.substring(0,a-1)}this.url=this.url+"/database/"+this.database_name;this.version=1},sync:function(a,c,b){this.send_create_database(a.definition,function(d){switch(d.r){case"ok":this.updateCSV_and_Generator(a,d.csv,function(){this.sync_datastore(a,d.csv,c,b)},this);break;case"new_replica_number":console.log("new_replica_number",d.replica_number);a.setReplicaNumber(d.replica_number,function(){c.call(b,{r:"again"})},b);break;case"new_generation_number":if(d.generation>a.definition.generation){a.definition.set({generation:d.generation},function(){a.reset(function(){c.call(b,{r:"again"})},this)},this)}else{}break;default:c.call(b,d);break}},this)},updateCSV_and_Generator:function(b,a,d,c){new Ext.data.Transaction(b,function(e){e.updateReplicaNumbers(a);e.updateGenerator(a);e.commit(d,c)},this)},send_create_database:function(a,d,b){var c=a.encode();this.sendRequest("POST",a.database_name,undefined,{},c,function(e){e.csv=new Ext.data.CSV().decode(e.csv);d.call(b,e)},this)},sync_datastore:function(a,d,c,b){a.getUpdates(d,function(e,f){this.put_database_updates(a.definition,e,f,function(g){if(d.dominates(a.csv)){this.updateCSV_and_Generator(a,d,function(){this.get_database_updates(a,c,b)},this)}else{c.call(b,{r:"ok"})}},this)},this)},put_database_updates:function(a,c,d,e,b){if((c&&!c.isEmpty())||(d&&!d.isEmpty())){this.send_put_database_updates(a,c,d,function(f){e.call(b)},this)}else{e.call(b,{r:"ok"})}},send_put_database_updates:function(a,d,e,f,b){var c={updates:Ext.encode(d.encode()),csv:e.encode()};if(!d.isEmpty()){console.log("send_put_database_updates sending",d.length(),"updates")}this.sendRequest("POST",a.database_name,"updates",{},c,f,b)},get_database_updates:function(a,c,b){this.send_get_database_updates(a.definition,a.csv,function(d){if(d.r=="ok"){a.putUpdates(d.updates,d.csv,c,b)}else{c.call(b,d)}},this)},send_get_database_updates:function(b,a,e,c){var d={csv:a.encode()};this.sendRequest("GET",b.database_name,"updates",d,undefined,function(f){var g=new Ext.data.CSV();if(f.csv){g.decode(f.csv)}f.csv=g;f.updates=new Ext.data.Updates().decode(f.updates);if(!f.updates.isEmpty()){console.log("send_get_database_updates received",f.updates.length(),"updates")}e.call(c,f)},this)},sendRequest:function(d,h,a,e,f,j,k){var g=f?Ext.encode(f).length:0;console.log("sendRequest send",d,h,a,"sent",g,"bytes");var c=new Date().getTime();var b=this.url;if(a){b=b+"/"+a}e.key=this.key;e.v=this.version;Ext.Ajax.useDefaultXhrHeader=false;Ext.Ajax.request({method:d,url:b,params:e,jsonData:f,success:function(m){var n=new Date().getTime();var l=m.responseText?m.responseText.length:0;console.log("sendRequest receive",d,h,a,"took",n-c,"ms, received",l,"bytes");j.call(k,Ext.decode(m.responseText))},failure:function(l,m){j.call(k,{r:"error",status:l.status,statusText:l.statusText})}})},});Ext.data.Transaction=Ext.extend(Object,{constructor:function(a,c,b){this.proxy=a;this.store=a.store;this.generatorChanged=false;this.originalGenerator=a.generator;this.modifiedGenerator=new Ext.data.CSGenerator(a.generator);this.csvChanged=false;this.originalCSV=a.csv;this.modifiedCSV=new Ext.data.CSV(a.csv);this.cache={};this.toCreate=[];this.toUpdate=[];this.toDestroy=[];this.store.getIndex(function(d){this.indexChanged=false;this.index=d;this.store.getCSIndex(function(e){this.csivChanged=false;this.csiv=e;c.call(b,this)},this)},this)},generateChangeStamp:function(){var a=this.modifiedGenerator.generateChangeStamp();this.modifiedCSV.addCS(a);this.generatorChanged=true;this.csvChanged=true;return a},create:function(a){this.addToCache(a);this.addToList(this.toCreate,a)},read:function(c,d,b){var a=this.cache[c];if(a){d.call(b,a)}else{this.store.read(c,function(e){this.addToCache(e);d.call(b,e)},this)}},update:function(a){this.addToCache(a);this.addToList(this.toUpdate,a)},destroy:function(a){this.toDestroy.push(a)},updateIDIndex:function(b,a){this.indexChanged=this.index[b]!=a;this.index[b]=a},lookupIDIndex:function(c,b,a){b.call(a,this.index[c])},updateCS:function(c,b,a){if(c&&b){if(!c.equals(b)){this.csvChanged=this.modifiedCSV.addX(b)||this.csvChanged;this.csivChanged=true;this.csiv.add(b,a)}}else{if(c){}else{if(b){this.csvChanged=this.modifiedCSV.addX(b)||this.csvChanged;this.csivChanged=true;this.csiv.add(b,a)}}}},updateCSV:function(a){this.csvChanged=this.modifiedCSV.addX(a)||this.csvChanged},updateReplicaNumbers:function(a){this.csvChanged=this.modifiedCSV.addReplicaNumbers(a)||this.csvChanged},updateGenerator:function(a){this.generatorChanged=this.originalGenerator.seenCSV(a)},commit:function(e,c){var d=new Date().getTime();this.toCreate=Ext.data.array.unique(this.toCreate);this.toUpdate=Ext.data.array.unique(this.toUpdate);this.toUpdate=Ext.data.array.minus(this.toUpdate,this.toCreate);var b=this.getRecordsForList(this.toCreate);var a=this.getRecordsForList(this.toUpdate);this.store.create(b,function(){this.store.update(a,function(){this.store.destroy(this.toDestroy,function(){this.store.setIndex(this.indexChanged?this.index:undefined,function(){this.store.setCSIndex(this.csivChanged?this.csiv:undefined,function(){if(this.generatorChanged){this.originalGenerator.set(this.modifiedGenerator)}if(this.csvChanged){this.originalCSV.addCSV(this.modifiedCSV);this.generatorChanged=this.originalGenerator.seenCSV(this.originalCSV)}this.proxy.writeConfig_Generator(this.generatorChanged?this.originalGenerator:undefined,function(){this.proxy.writeConfig_CSV(this.csvChanged?this.originalCSV:undefined,function(){var g=new Date().getTime();var f=g-d;if(f>9){console.log("commit",f,"ms")}e.call(c,b,a)},this)},this)},this)},this)},this)},this)},this)},addToCache:function(c){if(c){if(Ext.isArray(c)){var b=c.length;for(var d=0;d<b;d++){var a=c[d];var e=a.data[Ext.data.SyncModel.OID];this.cache[e]=a}}else{this.cache[c.data[Ext.data.SyncModel.OID]]=c}}},addToList:function(f,c){if(c){if(Ext.isArray(c)){var b=c.length;for(var d=0;d<b;d++){var a=c[d];var e=a.data[Ext.data.SyncModel.OID];f.push(e)}}else{f.push(c.data[Ext.data.SyncModel.OID])}}},getRecordsForList:function(d){var b=[];var a=d.length;for(var c=0;c<a;c++){var e=d[c];b.push(this.cache[e])}return b}});Ext.data.Updates=Ext.extend(Object,{updates:undefined,constructor:function(a){this.updates=a||[];this.updates.forEach(function(b){if(!(b.c instanceof Ext.data.CS)){b.c=new Ext.data.CS(b.c)}});this.updates.sort(function(d,c){return d.c.compare(c.c)})},push:function(b){var a=this.updates[this.updates.length];if(!b.c.greaterThan(a.c)){throw"Error - Updates - Tried to push updates in wrong order. "+Ext.encode(b)+" <= "+Ext.encode(a)}this.updates.push(b)},isEmpty:function(){return this.updates.length<1},length:function(){return this.updates.length},forEach:function(b,a){this.updates.forEach(b,a)},forEachAsync:function(d,c,a,b){Ext.data.array.forEachAsync(this.updates,d,c,a,b)},chunks:function(f){var e=[];var b=this.updates.length;var h=(b/f)+1;for(var d=0;d<h;d++){var g=d*f;var a=g+f;var c=new Ext.data.Updates();c.updates=this.updates.slice(g,a);e.push(c)}return e},decode:function(j){this.updates=[];if(j){var e=j.length;var f,d,a,b,k,h;for(var g=0;g<e;g++){f=j[g];switch(f.length){case 3:a=d;b=f[0];k=f[1];h=f[2];break;case 4:a=f[0];b=f[1];k=f[2];h=f[3];d=a;break}h=((h instanceof Ext.data.CS)?h:new Ext.data.CS(h));this.updates.push({i:a,p:b,v:k,c:h})}}return this},encode:function(){var e=[];var a=this.updates.length;var c,f,d;for(var b=0;b<a;b++){f=this.updates[b];d=((f.c instanceof Ext.data.CS)?f.c.to_s():f.c);if(f.i===c){e.push([f.p,f.v,d])}else{e.push([f.i,f.p,f.v,d]);c=f.i}}return e},});Ext.data.SyncModel={STATE:"_state",TOMBSTONE:"_ts",OID:"_oid",REF:"_ref",MODEL:"_model",state:undefined,createReplStorageModel:function(a){var c=this.fields.items.slice(0);c=c.concat([{name:"_state"},{name:"_ts"},{name:"_oid"},{name:"_ref"},{name:"_model"}]);var b=Ext.define("Sencha.StorageModel."+a,{extend:"Ext.data.Model",fields:c,idProperty:Ext.data.SyncModel.OID});return b},oid:function(){return this.data[Ext.data.SyncModel.OID]},ref:function(){return this.data[Ext.data.SyncModel.REF]},userData:function(){var b={};for(var a in this.data){if(a[0]!=="_"){b[a]=this.data[a]}}return b},isSystemModel:function(){var a=this.data[Ext.data.SyncModel.MODEL];return a!==undefined&&a!==""&&a.indexOf("Ext.data.",0)===0},changeReplicaNumber:function(a,c){this.setup();var d=false;this.forEachCS(function(g){var f=g.changeReplicaNumber(a,c);d=d||f;return g},this);var b=this.oid();if(b){var e=new Ext.data.CS(b);if(e.changeReplicaNumber(a,c)){this.data[Ext.data.SyncModel.OID]=e.to_s();d=true}}return d},setCreateState:function(a){if(this.data[Ext.data.SyncModel.OID]){console.log("Error: Record has already been created.",Ext.encode(this.data))}else{this.state={};var b=a.generateChangeStamp();this.setPair(a,Ext.data.SyncModel.OID,b.to_s(),b);this.forEachValue(this.data,[],function(d,c){if(d[0]!==Ext.data.SyncModel.OID){this.setCS(a,d,a.generateChangeStamp())}},this)}},setUpdateState:function(a){var b=this.getChanges();for(name in b){if(name!==Ext.data.SyncModel.STATE&&name!==Ext.data.SyncModel.OID){this.setUpdateStateValue(a,[name],this.modified[name],b[name])}}},setUpdateStateValue:function(c,g,b,f){if(this.isComplexValueType(f)){if(b){var d={};if(this.isComplexValueType(b)){if(this.valueType(b)===this.valueType(f)){d=Ext.data.utilities.minus(f,b);var h=Ext.data.utilities.intersection(f,b);for(var e in h){if(h.hasOwnProperty(e)){if(b[e]!==f[e]){d[e]=f[e]}}}}else{d=f;this.setCS(c,g,c.generateChangeStamp())}}else{d=f;this.setCS(c,g,c.generateChangeStamp())}}else{d=f;this.setCS(c,g,c.generateChangeStamp())}for(var e in d){if(d.hasOwnProperty(e)){var a=b?b[e]:undefined;this.setUpdateStateValue(c,g.concat(e),a,f[e])}}}else{this.setCS(c,g,c.generateChangeStamp())}},setDestroyState:function(a){var b=a.generateChangeStamp();this.data[Ext.data.SyncModel.TOMBSTONE]=b.to_s();this.setCS(a,Ext.data.SyncModel.TOMBSTONE,b)},isDestroyed:function(){var a=this.data[Ext.data.SyncModel.TOMBSTONE];return(a!==undefined&&a!=="")},isNotDestroyed:function(){var a=this.data[Ext.data.SyncModel.TOMBSTONE];return(a===undefined||a==="")},getUpdates:function(a){this.setup();var c=[];var b=this.oid();this.forEachPair(this.data,this.state,[],[],function(g,d,f){if(f){var e=a.get(f);if(!e||e.lessThan(f)){c.push({i:b,p:g.length==1?g[0]:g,v:d.length==1?d[0]:d,c:f})}}},this);if(c.length>0){}return c},putUpdate:function(a,b){return this.setPair(a,b.p,b.v,b.c)},equals:function(a){this.forEachPair(this.data,this.state,[],[],function(f,b,c){var e=a.getPair(f);var d=b[b.length-1];if(!(c.equals(a.c)&&d===a.v)){return false}},this);return true},forEachPair:function(e,a,n,h,k,l){this.setup();for(var b in a){if(a.hasOwnProperty(b)){var c=a[b];var f=e[b];var d=n.concat(b);var j=this.valueType(f);var g;switch(j){case"object":g={};break;case"array":g=[[]];break;default:g=f}var m=h.concat(g);switch(this.valueType(c)){case"string":k.call(l,d,m,new Ext.data.CS(c));break;case"array":switch(j){case"undefined":console.log("Warning - There was no data for the state at path",d);console.log("Warning -",Ext.encode(this.data));break;case"object":case"array":k.call(l,d,m,new Ext.data.CS(c[0]));this.forEachPair(f,c[1],d,m,k,l);break;default:k.call(l,d,m,new Ext.data.CS(c[0]));break}break}}}},forEachValue:function(c,e,g,b){var f,a;for(f in c){if(c.hasOwnProperty(f)){a=c[f];if(a!==this.state){var d=e.concat(f);g.call(b,d,a);if(this.isComplexValueType(a)){this.forEachValue(a,d,g,b)}}}}},getCSV:function(){var a=new Ext.data.CSV();this.forEachCS(function(b){a.addCS(b)},this);return a},getAllCS:function(){var a=[];this.forEachCS(function(b){a.push(new Ext.data.CS(b))},this);return a},forEachCS:function(e,b,c){c=c||this.data[Ext.data.SyncModel.STATE];for(name in c){if(c.hasOwnProperty(name)){var d=c[name];switch(this.valueType(d)){case"string":var a=e.call(b,new Ext.data.CS(d));if(a){c[name]=a.to_s()}break;case"array":var a=e.call(b,new Ext.data.CS(d[0]));if(a){c[name][0]=a.to_s()}this.forEachCS(e,b,d[1]);break}}}},getCS:function(g){this.setup();var d=this.state;if(Ext.isArray(g)){var a=g.length;var f=a-1;for(var c=0;c<a;c++){var b=g[c];if(c===f){return this.do_getCS(d,b)}else{d=this.do_getState(d,b)}}}else{return this.do_getCS(d,g)}},do_getCS:function(c,a){var b=undefined;var c=c[a];if(c){switch(this.valueType(c)){case"string":b=new Ext.data.CS(c);break;case"array":b=new Ext.data.CS(c[0]);break;default:console.log("Error - SyncModel - do_getCS - unexpected type in state for",a,":",typeof c,c);console.log("state",Ext.encode(this.data));b=new Ext.data.CS();break}}return b},setCS:function(d,j,f){this.setup();var g=this.state;if(Ext.isArray(j)){var a=j.length;var h=a-1;for(var c=0;c<a;c++){var b=j[c];if(c===h){this.do_setCS(d,g,b,f)}else{g=this.do_getState(g,b)}}}else{this.do_setCS(d,g,j,f)}},do_setCS:function(c,e,b,d){var g;var f=(d instanceof Ext.data.CS)?d.to_s():d;var a=e[b];if(a){switch(this.valueType(a)){case"string":g=new Ext.data.CS(a);e[b]=f;break;case"array":g=new Ext.data.CS(a[0]);a[0]=f;break;default:console.log("Error - SyncModel - do_setCS - unexpected type in state for",b,":",typeof a,a);console.log("state",Ext.encode(e));console.log("name",b,"cs",f);e[b]=f}}else{e[b]=f}c.updateCS(g,d,this.oid())},getPair:function(h){this.setup();var f=this.data;var d=this.state;if(Ext.isArray(h)){var a=h.length;var g=a-1;for(var c=0;c<a;c++){var b=h[c];if(c===g){return{v:f?f[b]:f,c:this.do_getCS(d,b)}}else{d=this.do_getState(d,b);f=f?f[b]:f}}}else{return{v:f[h],c:this.do_getCS(d,h)}}},setPair:function(u,v,s,d){var k=false;this.setup();if(!Ext.isArray(v)){v=[v];s=[s]}var m=this.data;var c=this.state;var f=v.length;var n=f-1;for(var j=0;j<f;j++){var b=v[j];var q=s[j];var p=this.do_getCS(c,b);var o=m[b];var h=this.valueType(o);var g=this.valueType(q);var a=((h==="object"&&g==="object")||(h==="array"&&g==="array"));if(p){if(d.greaterThan(p)){if(a){q=undefined}if(this.do_setPair(u,m,c,b,q,d)){k=true}}else{if(a){}else{return k}}}else{if(this.do_setPair(u,m,c,b,q,d)){k=true}}if(j!==n){m=this.do_getData(m,b);c=this.do_getState(c,b,d)}}return k},do_getState:function(d,a,c){var e=d[a];switch(this.valueType(e)){case"undefined":var b={};d[a]=[c,b];d=b;break;case"string":var b={};d[a]=[e,b];d=b;break;case"array":d=e[1];break;default:throw"Error - SyncModel - do_getState - unexpected type in state: "+(typeof e)+" "+e}return d},do_setPair:function(c,e,d,a,b,f){var g=false;if(b!==undefined){this.do_setData(e,a,b);g=true}if(f!==undefined){this.do_setCS(c,d,a,f);g=true}return g},do_getData:function(b,a){return b[a]},do_setData:function(c,a,b){c[a]=b},valueType:function(b){var a=typeof b;if(a==="object"&&(b instanceof Array)){a="array"}return a},valueEquals:function(e,d){var c=false;var b=this.valueType(e);var a=this.valueType(d);if(b===a){switch(b){case"object":case"array":c=Ext.encode(e)===Ext.encode(d);break;default:c=e===d}}return c},isComplexValueType:function(a){return(typeof a==="object")},setup:function(){this.data[Ext.data.SyncModel.STATE]=this.data[Ext.data.SyncModel.STATE]||{};this.state=this.data[Ext.data.SyncModel.STATE]}};